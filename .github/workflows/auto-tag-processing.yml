name: Auto Tag Processing

on:
  #push:
  #  branches:
  #    - main
  workflow_dispatch: {}


permissions:
  contents: write # リポジトリにタグをプッシュするために必要

jobs:
  check-template:
    runs-on: ubuntu-latest
    outputs:
      is_template: ${{ steps.check_template.outputs.is_template }}
    steps:
      - name: Check if repository is a template
        id: check_template
        run: |
          repo_name="${GITHUB_REPOSITORY##*/}"
          if echo "$repo_name" | grep -i "template" ; then
            echo "is_template=true" >> $GITHUB_OUTPUT
            echo "This repository is a template. Exiting."
          else
            echo "is_template=false" >> $GITHUB_OUTPUT
            echo "This repository is not a template. Continuing."
          fi

  check-repo-ready:
    runs-on: ubuntu-latest
    needs: check-template
    if: needs.check-template.outputs.is_template == 'false'
    outputs:
      repo_ready: ${{ steps.check_repo_ready.outputs.repo_ready }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if repository is ready
        id: check_repo_ready
        run: |
          TAGS=$(git tag)
          # v0.0.0タグが存在しない場合はリポ作成未完了とみなす
          if [ -z "$TAGS" ] || ! echo "$TAGS" | grep -q "^v0\.0\.0$"; then
            echo "repo_ready=false" >> $GITHUB_OUTPUT
            echo "No v0.0.0 tag found (no tags or v0.0.0 missing). Repository not ready. Exiting."
          else
            # v0.0.0タグのコミットSHAを取得
            INIT_COMMIT=$(git rev-list -n 1 v0.0.0)
            # PushイベントのコミットSHAを取得
            CURRENT_COMMIT="${GITHUB_SHA}"

            # v0.0.0が現在のコミットの祖先かどうかを確認
            if git merge-base --is-ancestor "$INIT_COMMIT" "$CURRENT_COMMIT"; then
              if [ "$INIT_COMMIT" = "$CURRENT_COMMIT" ]; then
                # 現在のコミットがv0.0.0と同じ場合はリポ作成未完了とみなす
                echo "repo_ready=false" >> $GITHUB_OUTPUT
                echo "Current commit is v0.0.0. Repository not ready. Exiting."
              else
                # v0.0.0より後のコミットであればリポ作成完了とみなす
                echo "repo_ready=true" >> $GITHUB_OUTPUT
                echo "Repository is ready. Continuing."
              fi
            else
              # v0.0.0より前のコミットの場合はリポ作成未完了とみなす
              echo "repo_ready=false" >> $GITHUB_OUTPUT
              echo "Current commit is before v0.0.0. Repository not ready. Exiting."
            fi
          fi

  tag-processing:
    runs-on: ubuntu-latest
    needs: check-repo-ready
    if: needs.check-repo-ready.outputs.repo_ready == 'true'
    outputs:
      new_tag: ${{ steps.process-labels-and-tag.outputs.new_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get related PR labels
        id: pr_labels
        uses: actions/github-script@v7
        with:
          script: |
            const commitSha = process.env.GITHUB_SHA;
            // mainブランチにマージされたPRを検索
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "closed",
              base: "main",
              sort: "updated",
              direction: "desc",
              per_page: 10
            });
            // このコミットを含むPRを探す
            const pr = prs.find(pr => pr.merge_commit_sha === commitSha);
            if (!pr) {
              core.info("No related PR found.");
              core.setOutput("labels", "[]");
              return;
            }
            const labels = pr.labels.map(l => l.name);
            core.setOutput("labels", JSON.stringify(labels));

      - name: Process Labels and Tag
        id: process-labels-and-tag
        uses: actions/github-script@v7
        with:
          script: |
            const labels = JSON.parse('${{ steps.pr_labels.outputs.labels }}');
            let bumpType = null;
            if (labels.includes('release:major')) bumpType = 'major';
            else if (labels.includes('release:minor')) bumpType = 'minor';
            else if (labels.includes('release:patch')) bumpType = 'patch';

            if (!bumpType) {
              core.info('No release label found. Exiting.');
              return;
            }
            core.info(`Bump type detected: ${bumpType}`);

            // 最新のタグを取得
            const tags = await github.rest.repos.listTags({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1
            });
            let latestTag = tags.data.length > 0 ? tags.data[0].name : 'v0.0.0';
            core.info(`Latest tag: ${latestTag}`);

            let [major, minor, patch] = latestTag.replace(/^v/, '').split('.').map(x => parseInt(x) || 0);
            if (bumpType === 'major') { major++; minor = 0; patch = 0; }
            else if (bumpType === 'minor') { minor++; patch = 0; }
            else if (bumpType === 'patch') { patch++; }

            const newTag = `v${major}.${minor}.${patch}`;
            core.info(`New tag: ${newTag}`);

            // 新しいタグを作成
            const commitSha = process.env.GITHUB_SHA;
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${newTag}`,
              sha: commitSha
            });
            core.setOutput('new_tag', newTag);

  deploy:
    needs: tag-processing
    if: ${{ needs.tag-processing.outputs.new_tag != '' }}
    uses: ./.github/workflows/auto-deploy-use-selfhosted-runner.yml
    with:
      tag: ${{ needs.tag-processing.outputs.new_tag }}
