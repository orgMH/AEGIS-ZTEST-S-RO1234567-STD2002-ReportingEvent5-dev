#!/bin/sh

# ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
branch=$(git rev-parse --abbrev-ref HEAD)

# main, master, qaãƒ–ãƒ©ãƒ³ãƒã§ã¯commitã§ãã¾ã›ã‚“ã€‚
if [ "$branch" = "main" ] || [ "$branch" = "master" ] || [ "$branch" = "qa" ]; then
  echo "âŒ $branch ãƒ–ãƒ©ãƒ³ãƒã§ã¯commitã§ãã¾ã›ã‚“ã€‚åˆ¥ã®ãƒ–ãƒ©ãƒ³ãƒã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚"
  exit 1
fi

# =======================================================
# renv.lock ãƒã‚§ãƒƒã‚¯ (ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸå†…å®¹ã‚’ç¢ºèª)
# =======================================================
echo "ğŸ” renv.lock ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã¾ã™..."

# 1. renv.lock ãŒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã‚¨ãƒªã‚¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
if ! git rev-parse --verify -q :renv.lock > /dev/null; then
  # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ãƒã‚§ãƒƒã‚¯å¯¾è±¡å¤–ã¨ã—ã¦æ­£å¸¸çµ‚äº†
  echo "â„¹ï¸ renv.lock ãŒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã‚¨ãƒªã‚¢ã«è¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
  exit 0
fi

LOCK_CONTENT=$(git show :renv.lock)

# 2. æ§‹é€ ãƒã‚§ãƒƒã‚¯ ("R" ãƒãƒ¼ãƒ‰ã¨ "Repositories" ãƒãƒ¼ãƒ‰)
if ! echo "$LOCK_CONTENT" | grep -q '"R":' || ! echo "$LOCK_CONTENT" | grep -q '"Repositories":'; then
  echo "âŒ renv.lock ã®å½¢å¼ãŒä¸æ­£ã§ã™ ('R' ã¾ãŸã¯ 'Repositories' ãƒãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“)ã€‚"
  exit 1
fi

# 3. URL ãƒã‚§ãƒƒã‚¯ (Repositories ãƒãƒ¼ãƒ‰å†…ã® URL ãŒæŒ‡å®šã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã§å§‹ã¾ã£ã¦ã„ã‚‹ã‹)
# awk ã‚’ä½¿ç”¨ã—ã¦ Repositories ãƒ–ãƒ­ãƒƒã‚¯å†…ã® URL ã®ã¿ã‚’æŠ½å‡ºãƒ»æ¤œè¨¼
ERROR_MSG=$(echo "$LOCK_CONTENT" | awk '
BEGIN { in_repo = 0; exit_code = 0; }
/"Repositories": \[/ { in_repo = 1; next; }
in_repo && /\]/ { in_repo = 0; exit; } # ãƒªã‚¹ãƒˆçµ‚äº†ï¼ˆç°¡æ˜“åˆ¤å®šï¼‰
in_repo && /"URL":/ {
    # è¡Œã‹ã‚‰ URL æ–‡å­—åˆ—ã‚’æŠ½å‡º: "URL": "VALUE", -> VALUE
    line = $0;
    sub(/.*"URL": "/, "", line); # ã‚­ãƒ¼éƒ¨åˆ†å‰Šé™¤
    sub(/".*/, "", line);        # æœ«å°¾ã® " ä»¥é™ã‚’å‰Šé™¤

    #prefix = "https://aegisrspm.akaws-r-alb.onecloudlabo.com/";
    prefix = "https://aegisrspm.";
    # prefix ã§å§‹ã¾ã£ã¦ã„ã‚‹ã‹ç¢ºèª
    if (substr(line, 1, length(prefix)) != prefix) {
        print "âŒ ä¸æ­£ãªãƒªãƒã‚¸ãƒˆãƒª URL ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ: " line;
        exit_code = 1;
        exit 1;
    }
}
END { if (exit_code == 1) exit 1; }
')
EXIT_CODE=$?

# awk ã®çµ‚äº†ã‚³ãƒ¼ãƒ‰ãŒã‚¨ãƒ©ãƒ¼(1)ãªã‚‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ­¢ã‚ã‚‹
if [ $EXIT_CODE -ne 0 ]; then
  echo "$ERROR_MSG"
  echo "âŒ URL ã¯ https://aegisrspm.ã§å§‹ã¾ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚"
  exit 1
fi

echo "âœ” ãƒã‚§ãƒƒã‚¯å®Œäº†"
exit 0
